---
title: "Reproducibility test"
author: "ross"
date: "8/25/2022"
output: html_document
---

```{r setup, include=FALSE}
options(rlib_downstream_check = FALSE)
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs_fxns}
library(drc)
library(quantreg)
library(mcr)
library(broom)
library(lubridate)
library(tidyverse)

# Create custom ggplot theme
theme_custom <- function() {
  theme_bw(base_size = 10, base_family = "Arial") %+replace%
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      panel.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      legend.background = element_rect(fill = NA, colour = NA),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 5)
    )
}
```

# Compare ED50s measured in 2021 to ED50s measured in 2020
```{r}
# Import data from 2020

# Import June 2020 data
ed50_202006 <- read_csv("data/reproducibility/processed/ed50_202006.csv") %>%
  mutate(nursery = case_when(nursery == "RR" ~ "rrt", TRUE ~ tolower(nursery))) %>%
  select(nursery, geno = name, ed50 = estimate_ed50, std.error = std_error_ed50) %>%
  mutate(date = "202006")

### old data that was in repo but dont know how it was made
# ed50_2020 <- read_csv("~/Projects/CBASS_FL_Acer/data/processed/ed50_values.csv") %>%
#   mutate(nursery = case_when(nursery == "mote" ~ "mml", TRUE ~ tolower(nursery))) %>%
#   select(nursery, geno, ed50_2020 = ed50, std.error_2020 = std.error)

### new Oct 2020 data freshly exported from CBASS_FL_Acer repo
ed50_202010 <- read_csv("data/reproducibility/processed/ed50_2020.csv") %>%
  mutate(nursery = case_when(nursery == "RR" ~ "rrt", TRUE ~ tolower(nursery))) %>%
  select(nursery, geno = name, ed50 = ed50, std.error = std.error)

# In 2020, some genotypes were run multiple times from the same nursery, indicated by (A), (B), (C), etc.
# Group these, and get the average ED50 for 2020 for each genotype from each nursery
ed50_202010 <- ed50_202010 %>%
  separate(geno, into = c("geno", "replicate"), sep = "\\(") %>%
  group_by(geno, nursery) %>%
  summarise(ed50 = weighted.mean(ed50, 1/std.error^2), 
            std.error = mean(std.error)) %>%
  ungroup() %>%
  select(nursery, geno, ed50, std.error) %>%
  mutate(date = "202010")

# Tidy 2021 data and join with 2020
### Choose filtered or unfiltered 2021 data
ed50_202109 <- read_csv("data/reproducibility/processed/ed50_202109.csv")
ed50_202109 <- ed50_202109 %>%
  mutate(ed50 = ed50.f,
         std.error = std.error.f,
         nursery = tolower(nursery)) %>%
  select(nursery, geno, ed50, std.error) %>%
  mutate(date = "202109")

# Combine all data and get only genos tested more than once
longdf <- bind_rows(ed50_202006, ed50_202010, ed50_202109) %>%
  group_by(nursery, geno) %>%
  filter(n() > 1) %>%
  ungroup()
```

# New analysis 2023

## Prefilter data based on ED50 std.error
```{r}


# Identify lower quality data as highest 10% standard error of ED50 parameter estimates
outliers <- longdf %>%
  group_by(nursery, geno) %>%
  summarize(meanse = mean(std.error)) %>%
  ungroup() %>%
  filter(meanse > quantile(meanse, 0.9))

# Remove genotypes with highest 10% standard error of ED50 parameter estimates
toplongdf <- longdf %>% filter(!geno %in% outliers$geno)
```

# Plot and analyze unadjusted data
```{r}
topwidedf <- toplongdf %>%
  pivot_wider(names_from = date, values_from = c(ed50, std.error))

means <- topwidedf %>% group_by(nursery) %>% summarise_all(mean, na.rm = T)

unadj.corr <- ggplot(topwidedf, aes(x = ed50_202010)) +
  facet_wrap(~ nursery) +
  #geom_point(data = means, aes(y = ed50_202109), pch = 1, size = 3, color = "red", alpha = 0.5) + 
  geom_point(aes(y = ed50_202109), pch = 1) +
  geom_point(aes(y = ed50_202006), pch = 2) +
  geom_abline(slope = 1, intercept = 0, lty = 2) +
  #stat_cor() +
  coord_fixed(xlim = range(toplongdf$ed50), ylim = range(toplongdf$ed50)) +
  theme_custom(); unadj.corr

# Analyze sources of variance
mod <- lm(ed50 ~ geno + nursery:date, data = toplongdf)
anova(mod)
summary(mod)
augment(mod, toplongdf) %>% arrange(-.cooksd)

mod2 <- lm(ed50_202109 ~ ed50_202010 + nursery, data = topwidedf)
anova(mod2)


# Get all pairwise differences between measurements of the same geno at the same nursery
res.unadj <- toplongdf %>% 
  group_by(nursery, geno) %>% 
  summarise(diff = combn(ed50,2,diff),
            test = combn(date,2,paste, simplify = FALSE)) %>%  
  mutate(pair = unlist(lapply(test, function(x)paste(x,collapse="-")))) %>%  
  select(-test) %>%
  ungroup()


# Get ECDF for plotting
dens <- density(abs(res.unadj$diff), adjust = 0.01)
dens <- tibble(x = dens$x, y = dens$y) %>%
  mutate(cd = cumsum(y)/sum(y))
# Get degree diffs for x% of cases from cumulative density
conf0.5 <- dens$x[which.min(abs(0.5 - dens$cd))]
conf0.9 <- dens$x[which.min(abs(0.9 - dens$cd))]

myecdf <- ggplot(res.unadj, aes(x = abs(diff))) +
  geom_segment(aes(y = 0.5, yend = 0.5, x = 0, xend = conf0.5), lty = 2, alpha = 0.4, lwd = 0.25) +
  geom_segment(aes(x = conf0.5, xend = conf0.5, y = 0, yend = 0.5), lty= 2, alpha = 0.4, lwd = 0.25) +
  geom_segment(aes(y = 0.9, yend = 0.9, x = 0, xend = conf0.9), lty = 2, alpha = 0.4, lwd = 0.25) +
  geom_segment(aes(x = conf0.9, xend = conf0.9, y = 0, yend = 0.9), lty= 2, alpha = 0.4, lwd = 0.25) +
  #geom_rect(data = myvals, aes(xmin = 0, xmax = diff, ymin = 0, ymax = perc), alpha = 0.2) +
  stat_ecdf(color = "red", alpha = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0, 1.2)) +
  scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 0.9, 1), labels = scales::percent, expand = c(0, 0)) +
  labs(x = "|Test 1 - Test 2| ΔED50 (°C)", y = "Percent of cases") +
  theme_custom(); myecdf
```


# Remove nursery / year effects
```{r}
# Model nursery and year effects to remove from data
indf <- toplongdf
mod <- lm(ed50 ~ nursery:date, data = indf)
# Add residuals from nursery*year fitted values to the grand mean ED50
out <- augment(mod, indf) %>%
  mutate(ed50_adj = mean(indf$ed50) + .resid) %>%
  select(geno, nursery, date, ed50, ed50_adj)
res.adj <- out %>% 
  group_by(nursery, geno) %>% 
  summarise(diff = combn(ed50_adj,2,diff),
            test = combn(date,2,paste, simplify = FALSE)) %>%  
  mutate(pair = unlist(lapply(test, function(x)paste(x,collapse="-")))) %>%  
  select(-test) %>%
  ungroup()

# Get ECDF for plotting
adjdens <- density(abs(res.adj$diff), adjust = 0.1)
adjdens <- tibble(x = adjdens$x, y = adjdens$y) %>%
  mutate(cd = cumsum(y)/sum(y))
# Get degree diffs for x% of cases from cumulative density
adjconf0.5 <- adjdens$x[which.min(abs(0.5 - adjdens$cd))]
adjconf0.9 <- adjdens$x[which.min(abs(0.9 - adjdens$cd))]


# Plot adjusted ED50s 2021 vs. 2020
adj.corr <- out %>% pivot_wider(names_from = date, values_from = c(ed50, ed50_adj)) %>%
  ggplot(aes(x = ed50_adj_202010)) +
  geom_point(aes(y = ed50_adj_202109), pch = 1) + #aes(color = sum.std.error)) +
  geom_point(aes(y = ed50_adj_202006), pch = 2) +
  #geom_smooth(method = "lm") +
  #geom_label(aes(label = geno, y = ed50_adj_202109), size = 2) +
  geom_ribbon(aes(ymin = ..x.. - adjconf0.5, ymax = ..x.. + adjconf0.5), alpha = 0.25) +
  geom_ribbon(aes(ymin = ..x.. - adjconf0.9, ymax = ..x.. + adjconf0.9), alpha = 0.25) +
  #annotate("text", x = 35, y = 37, label = round(adjconf0.9, 3)) +
  #annotate("text", x = 35, y = 36.8, label = round(adjconf0.5, 3)) +
  labs(x = "ED50 (°C) in Test 1", y = "ED50 (°C) in Test 2") +
  geom_abline(aes(slope = 1, intercept = 0), lty = 2, lwd = 0.25) +
  theme_custom() +
  #theme(legend.position = "none") +
  coord_fixed()


ecdf2 <- myecdf +
  #geom_segment(aes(y = 0.5, yend = 0.5, x = 0, xend = adjconf0.5), lty = 2) +
  geom_segment(aes(x = adjconf0.5, xend = adjconf0.5, y = 0, yend = 0.5), lty= 2, lwd = 0.25) +
  geom_text(x = adjconf0.5, y = 0.02, label = round(adjconf0.5, 2), adj = 1) +
  #geom_segment(aes(y = 0.9, yend = 0.9, x = 0, xend = adjconf0.9), lty = 2) +
  geom_segment(aes(x = adjconf0.9, xend = adjconf0.9, y = 0, yend = 0.9), lty= 2, lwd = 0.25) +
  geom_text(x = adjconf0.9, y = 0.02, label = round(adjconf0.9, 2), adj = 1) +
  #geom_rect(data = myvals, aes(xmin = 0, xmax = diff, ymin = 0, ymax = perc), alpha = 0.2) +
  stat_ecdf(data = res.adj, color = "red")
```

```{r}
# Plot combined figure
repro.fig <- plot_grid(unadj.corr, adj.corr, ecdf2, nrow = 1, 
                       labels = "auto", rel_widths = c(0.42, 0.29, 0.29))
ggsave(repro.fig, filename = "output/reprofig.png", width = 183, height = 80, units = "mm")
```





####------
# everything below is older code from arond reef futures conference...
# Filter out ED50 measurements with high error (lower confidence in value)
```{r}
# Filter just ED50s with lower standard errors
#ggplot(alldf, aes(x = std.error_2020, y = std.error_2021)) + geom_point()

# Calculate sum of the ED50 standard errors for 2020 and 2021
alldf <- alldf %>% mutate(sum.std.error = (std.error_2021 + std.error_2020))
#hist(alldf$sum.std.error, breaks = 50)
boxplot(alldf$sum.std.error)

# Take highest-confidence 50 genotypes based on lowest combined standard error on ED50 measurements
highconf <- alldf %>%
  arrange(sum.std.error) %>%
  slice(1:50)

# Plot raw ED50 values from 2021 vs. 2020 for high-confidence genotypes
plot1 %+% highconf

# Linear model for raw ED50 values
mod <- lm(ed50_2021 ~ ed50_2020 + nursery, data = highconf)
anova(mod)
```

# Plot raw/unadjusted
```{r}
# Plot raw/unadjusted ED50s from 2021 to 2020

means <- highconf %>%
  pivot_longer(cols = c(ed50_2021, ed50_2020), names_to = "year") %>%
  group_by(nursery, year) %>%
  summarise(meanval = mean(value),
            sd = sd(value)) %>%
  pivot_wider(names_from = year, values_from = c(meanval, sd)) %>%
  select(nursery, ed50_2020 = meanval_ed50_2020, ed50_2021 = meanval_ed50_2021,
         sd_2020 = sd_ed50_2020, sd_2021 = sd_ed50_2021) %>%
  ungroup()
means


p1 <- highconf %>%
  ggplot(aes(x = ed50_2020, y = ed50_2021, color = nursery, fill = nursery)) +
  geom_point(size = 1, pch = 16, stroke = 0.25) +
  geom_abline(aes(slope = 1, intercept = 0), lty = 2, lwd = 0.25) +
  labs(x = "ED50 (°C) in Test 1 (2020)", y = "ED50 (°C) in Test 2 (2021)") +
  theme_custom() +
  theme(legend.position = "none") #+
  #coord_fixed(expand = FALSE)
ggsave(p1, filename = "output/p1.png", height = 75, width = 50, units = "mm")

p2 <- p1 +
  geom_point(data = means, size = 4, pch = 16) +
  geom_errorbar(data = means, aes(xmin = ed50_2020 - sd_2020, xmax = ed50_2020 + sd_2020), width = 0) +
  geom_errorbar(data = means, aes(ymin = ed50_2021 - sd_2021, ymax = ed50_2021 + sd_2021), width = 0)
ggsave(p2, filename = "output/p2.png", height = 75, width = 50, units = "mm")

int <- highconf %>%
  mutate(pred = ed50_2020 - 1 * ed50_2021) %>%
  group_by(nursery) %>%
  summarise(int = mean(pred))

p3 <- p2 +
  #geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  geom_abline(aes(intercept = -int, slope = 1, color = nursery), data = int)
ggsave(p3, filename = "output/p3.png", height = 75, width = 50, units = "mm")
```

# Get adjusted ED50 values, removing nursery and year effects
```{r}
# Pivot to long form to model nursery:year differences and then subtract residuals
# Removes differences due to nursery and year to focus on genotype differences only
long <- highconf %>% drop_na() %>%
  select(nursery, geno, ed50_2021, ed50_2020) %>%
  pivot_longer(cols = c(ed50_2021, ed50_2020), names_to = "year", values_to = "ed50") 
mod <- lm(ed50 ~ nursery:year, data = long)
res <- augment(mod, long) %>%
  mutate(ed50_adj = mean(long$ed50) + .resid)

# Confirm that all nursery:year groups now have same mean value
means <- res %>%
  group_by(nursery, year) %>%
  summarise(meanvaladj = mean(ed50),
            sd = sd(ed50))

# Pivot to wide form to model 2021 vs. 2020
res2 <- res %>%
  select(nursery, geno, year, ed50_adj) %>%
  pivot_wider(names_from = year, values_from = ed50_adj)
```

# Compare ED50s from 2021 to 2020
```{r}
p4 <- res2 %>%
  ggplot(aes(x = ed50_2020, y = ed50_2021)) +
  geom_point(size = 1, pch = 1, stroke = 0.25) +
    geom_ribbon(aes(x = seq(34.8, 36.4, length.out = 50), 
                  ymin = ..x.. - filter(myvals, perc == 0.5) %>% pull(diff), 
                  ymax = ..x.. + filter(myvals, perc == 0.5) %>% pull(diff)), alpha = 0) +
  geom_ribbon(aes(x = seq(34.8, 36.4, length.out = 50),
                  ymin = ..x.. - filter(myvals, perc == 0.9) %>% pull(diff), 
                  ymax = ..x.. + filter(myvals, perc == 0.9) %>% pull(diff)), alpha = 0) +
  labs(x = "ED50 (°C) in Test 1 (2020)", y = "ED50 (°C) in Test 2 (2021)") +
  geom_abline(aes(slope = 1, intercept = 0), lty = 2, lwd = 0.25) +
  theme_custom() +
  theme(legend.position = "none") +
  coord_fixed(expand = FALSE)
ggsave(p4, filename = "output/p4.png", height = 75, width = 50, units = "mm")

p5 <- p4 + geom_segment(aes(y = ed50_2020, yend = ed50_2021, x = ed50_2020, xend = ed50_2020),
                  lwd = 0.2, color = "red")
ggsave(p5, filename = "output/p5.png", height = 75, width = 50, units = "mm")

# Model adjusted ED50ʻs from 2021 vs. 2020
## Linear model
mod.lm <- lm(ed50_2021 ~ ed50_2020, data = res2)
anova(mod.lm)
summary(mod.lm)
## Passing-Bablok, Deming, and quantile regressions
paba.reg <- mcreg(res2$ed50_2020, res2$ed50_2021, method.reg = "PaBa")
dem.reg <- mcreg(res2$ed50_2020, res2$ed50_2021, method.reg = "Deming")
mod.rq <- rq(ed50_2021 ~ ed50_2020, data = res2)

# Get ECDF for plotting
res2 <- res2 %>%
  mutate(diff = abs(ed50_2021 - ed50_2020))
dens <- density(res2$diff, adjust = 0.1)
dens <- tibble(x = dens$x, y = dens$y) %>%
  mutate(cd = cumsum(y)/sum(y))
# Get degree diffs for x% of cases from cumulative density
myvals <- tibble(perc = c(0.5, 0.9)) %>%
  mutate(diff = map_dbl(perc, ~ dens$x[which.min(abs(. - dens$cd))]))

# Plot ED50s with different regression lines
panelA <- res2 %>%
  ggplot(aes(x = ed50_2020, y = ed50_2021)) +
  geom_point(size = 1, pch = 1, stroke = 0.25) + #aes(color = abs(ed50_2020-ed50_2021) < 0.5)) +
  #geom_label(aes(label = geno)) +
  #geom_abline(aes(slope = coef(mod.lm)[2], intercept = coef(mod.lm)[1])) +
  #geom_abline(aes(slope = coef(mod.rq)[2], intercept = coef(mod.rq)[1])) +
  #geom_abline(aes(slope = paba.reg@para[2], intercept = paba.reg@para[1]), color = "blue") +
  #geom_abline(aes(slope = dem.reg@para[2], intercept = dem.reg@para[1]), color = "red") +
  geom_ribbon(aes(x = seq(34.8, 36.4, length.out = 50), 
                  ymin = ..x.. - filter(myvals, perc == 0.5) %>% pull(diff), 
                  ymax = ..x.. + filter(myvals, perc == 0.5) %>% pull(diff)), alpha = 0.2) +
  geom_ribbon(aes(x = seq(34.8, 36.4, length.out = 50),
                  ymin = ..x.. - filter(myvals, perc == 0.9) %>% pull(diff), 
                  ymax = ..x.. + filter(myvals, perc == 0.9) %>% pull(diff)), alpha = 0.2) +
  geom_abline(aes(slope = 1, intercept = 0), lty = 2, lwd = 0.25) +
  #ggpubr::stat_cor(method = "spearman", label.y = 36.7, label.x = 34.9, size = 3) +
  labs(x = "ED50 (°C) in Test 1 (2020)", y = "ED50 (°C) in Test 2 (2021)") +
  theme_custom() +
  theme(legend.position = "none") +
  coord_fixed(expand = FALSE); panelA
ggsave(panelA, filename = "output/panelA.png", height = 75, width = 50, units = "mm")

# Visualize ECDF
panelB <- ggplot(res2, aes(x = diff)) +
  #geom_segment(data = myvals, aes(y = perc, yend = perc, x = 0, xend = diff), lty = 2) +
  #geom_segment(data = myvals, aes(x = diff, xend = diff, y = 0, yend = perc), lty= 2) +
  geom_rect(data = myvals, aes(xmin = 0, xmax = diff, ymin = 0, ymax = perc), alpha = 0.2) +
  stat_ecdf(color = "red") +
  scale_x_continuous(breaks = seq(0,1.2,0.1), expand = c(0, 0), limits = c(0, 1.1)) +
  scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 0.9, 1), labels = scales::percent, expand = c(0, 0)) +
  labs(x = "|Test 1 - Test 2| ΔED50 (°C)", y = "Percent of cases") +
  theme_custom(); panelB 
ggsave(panelB, filename = "output/panelB.png", height = 75, width = 50, units = "mm")

# Visualize histogram of diffs
panelC <- res2 %>%
  mutate(diff = abs(ed50_2021 - ed50_2020)) %>%
  ggplot(aes(x = diff)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), binwidth = 0.05, boundary = 0, closed = "left") +
  scale_x_continuous(breaks = seq(0,1.2,0.1), expand = c(0, 0), limits = c(0, 1.1)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.17)) +
  labs(x = "|Test 1 - Test 2| ΔED50 (°C)", y = "Percent of cases") +
  theme_custom(); panelC

col2 <- cowplot::plot_grid(panelB, panelC, ncol = 1, labels = c("B", "C"))
#cowplot::plot_grid(panelA, col2, ncol = 2, labels = c("A", ""))
panelB

fig1 <- cowplot::plot_grid(panelA, panelB, ncol = 2, labels = "AUTO")
fig1
ggsave(fig1, filename = "output/fig1.png", width = 89, height = 75, units = "mm")
```


# Estimate repeatability of ED50 for same genotype
```{r}
# Repeatability
library(rptR)
out <- rpt(ed50 ~ nursery * year  + (1|geno), data = long, grname = c("geno", "Overdispersion", "Fixed", "Residual"), nboot = 1000, parallel = TRUE, adjusted = TRUE)
out
plot(out)
summary(out)
```


# Repeatability of pairwise ranks
```{r}
# Get all pairwise differences in adjusted ED50 between high confidence genos in 2020 and 2021
genos <- res2$geno
diffs2020 <- outer(res2$ed50_2020, res2$ed50_2020, `-`)
dimnames(diffs2020) <- list(geno1 = genos, geno2 = genos)
diffs2021 <- outer(res2$ed50_2021, res2$ed50_2021, `-`)
dimnames(diffs2021) <- list(geno1 = genos, geno2 = genos)

diffs2021 <- reshape2::melt(diffs2021, value.name = "diff")
diffs2020 <- reshape2::melt(diffs2020, value.name = "diff")
alldiffs <- as_tibble(full_join(diffs2020, diffs2021, by = c("geno1", "geno2"), suffix = c(".20", ".21")))

# Plot pairwise ED50 differences in 2021 as a function of how much HIGHER one genet's 2020 ED50 was
alldiffs %>% 
  filter(diff.20 > 0) %>%       # Get all 2020 comparisons where genet 1 HIGHER than genet 2
  ggplot(aes(x = diff.20, y = diff.21)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE)

alldiffs %>% arrange(-diff.20)

diffs2 <- alldiffs %>% 
  filter(diff.20 > 0) %>%
  mutate(higher21 = diff.21 > 0)
ggplot(diffs2, aes(x = diff.20, y = higher21)) + geom_jitter()
mod <- glm(higher21 ~ diff.20, data = diffs2, family = "binomial")
anova(mod)

# Get probability that rank order is same given difference in 2020 ED50s
emm <- emmeans::emmeans(mod, specs = "diff.20", at = list(diff.20 = seq(0,2.0,0.01)), type = "response")

fig2 <- ggplot(data.frame(emm), aes(x = diff.20, y = prob)) +
  geom_line() +
  geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), alpha = 0.2) +
  labs(x = "Pairwise difference in ED50 (°C)\nin Test 1 (2020)",
       y = "Probability of same rank order\nin Test 2 (2021)") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 2)) +
  theme_custom() +
  theme(text = element_text(size = 14)) +
  coord_cartesian(ylim = c(0.5, 1), expand = c(0, 0)); fig2

ggsave(fig2, filename = "output/fig2.png", width = 89, height = 89, units = "mm")

ggsave(fig2, filename = "output/f1.png", width = 50, height = 50, units = "mm")

```




```{r old_code, include = F, eval = F, echo = F}

#Repeatability coefficient
# Mean within-subject sample variance
res3 <- res2 %>% rowwise() %>% mutate(var = var(c(ed50_2021, ed50_2020)))
var_w <- mean(res3$var, na.rm = TRUE)
# Within-subject sample standard deviation
s_w <- sqrt(var_w)
# Coefficient of repeatability
rc95 <- 1.96 * sqrt(2) * s_w
rc95   # 95% of the time, repeat measurements will differ by less than rc     0.84
rc90 <- 1.645 * sqrt(2) * s_w
rc90

# statistical repeatability
probs <- tibble(
  p = seq(0.01, 0.99, 0.01),
  t = qt((1-seq(0.01,0.99,0.01))/2, lower.tail = F, df = Inf),
  y = t * sqrt(2) * s_w
)

ggplot(probs, aes(y = p, x = y)) +
  geom_line() +
  labs(y = "Percent of cases (genets)", x = "Test - retest difference in ED50 (°C)") +
  geom_vline(aes(xintercept = 0.95), lty = 2) +
  annotate("text", x = 0.8, y = 0.7, label = "Repeatability coefficient")

val <- qt((1-seq(0.01,0.99,0.01))/2, lower.tail = F, df = Inf) * sqrt(2) * s_w
plot(seq(0.01,0.99,0.01), val)
pt(seq(0.01,0.99,0.01), df = Inf) * sqrt(2) * s_w
plot(seq(0.01,0.99,0.01), tt)



```

