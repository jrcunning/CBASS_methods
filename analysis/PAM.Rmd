---
title: "Reproducibility test"
author: "ross"
date: "8/25/2022"
output: html_document
---

```{r setup, include=FALSE}
options(rlib_downstream_check = FALSE)
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs_fxns}
library(drc)
library(quantreg)
library(mcr)
library(broom)
library(lubridate)
library(tidyverse)

# Create custom ggplot theme
theme_custom <- function() {
  theme_bw(base_size = 10, base_family = "Arial") %+replace%
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      panel.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      legend.background = element_rect(fill = NA, colour = NA),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 5)
    )
}
```

# Compare ED50s measured in 2021 to ED50s measured in 2020
```{r}
# Import data from 2020

# Import June 2020 data
ed50_202006 <- read_csv("data/reproducibility/processed/ed50_202006.csv") %>%
  mutate(nursery = case_when(nursery == "RR" ~ "rrt", TRUE ~ tolower(nursery))) %>%
  select(nursery, geno = name, ed50 = estimate_ed50, std.error = std_error_ed50) %>%
  mutate(date = "202006")

### old data that was in repo but dont know how it was made
# ed50_2020 <- read_csv("~/Projects/CBASS_FL_Acer/data/processed/ed50_values.csv") %>%
#   mutate(nursery = case_when(nursery == "mote" ~ "mml", TRUE ~ tolower(nursery))) %>%
#   select(nursery, geno, ed50_2020 = ed50, std.error_2020 = std.error)

### new Oct 2020 data freshly exported from CBASS_FL_Acer repo
ed50_202010 <- read_csv("data/reproducibility/processed/ed50_2020.csv") %>%
  mutate(nursery = case_when(nursery == "RR" ~ "rrt", TRUE ~ tolower(nursery))) %>%
  select(nursery, geno = name, ed50 = ed50, std.error = std.error)

# In 2020, some genotypes were run multiple times from the same nursery, indicated by (A), (B), (C), etc.
# Group these, and get the average ED50 for 2020 for each genotype from each nursery
ed50_202010 <- ed50_202010 %>%
  separate(geno, into = c("geno", "replicate"), sep = "\\(") %>%
  group_by(geno, nursery) %>%
  summarise(ed50 = weighted.mean(ed50, 1/std.error^2), 
            std.error = mean(std.error)) %>%
  ungroup() %>%
  select(nursery, geno, ed50, std.error) %>%
  mutate(date = "202010")

# Tidy 2021 data and join with 2020
### Choose filtered or unfiltered 2021 data
ed50_202109 <- read_csv("data/reproducibility/processed/ed50_202109.csv")
ed50_202109 <- ed50_202109 %>%
  mutate(ed50 = ed50.f,
         std.error = std.error.f,
         nursery = tolower(nursery)) %>%
  select(nursery, geno, ed50, std.error) %>%
  mutate(date = "202109")

# Combine all data and get only genos tested more than once
longdf <- bind_rows(ed50_202006, ed50_202010, ed50_202109) %>%
  group_by(nursery, geno) %>%
  filter(n() > 1) %>%
  ungroup()
```

# New analysis 2023

## Prefilter data based on ED50 std.error
```{r}
# Identify lower quality data as highest 10% standard error of ED50 parameter estimates
outliers <- longdf %>%
  group_by(nursery, geno) %>%
  summarize(meanse = mean(std.error)) %>%
  ungroup() %>%
  filter(meanse > quantile(meanse, 0.9))

# Remove genotypes with highest 10% standard error of ED50 parameter estimates
toplongdf <- longdf #%>% filter(!geno %in% outliers$geno)
```

# Plot and analyze unadjusted data
```{r}
# Analyze sources of variance
mod <- lm(ed50 ~ geno + nursery:date, data = toplongdf)
anova(mod)
ress <- augment(mod, toplongdf) %>% arrange(-.cooksd)
hist(ress$.cooksd, breaks = 50)
highcooks <- ress %>% filter(.cooksd > 0.05)

# Remove genotypes with highest cooksD
toplongdf <- toplongdf %>% filter(!geno %in% highcooks$geno)

topwidedf <- toplongdf %>%
  pivot_wider(names_from = date, values_from = c(ed50, std.error))



mod2 <- lm(ed50_202109 ~ ed50_202010 + nursery, data = topwidedf)
anova(mod2)

unadj.corr <- ggplot(topwidedf, aes(x = ed50_202010)) +
  facet_wrap(~ nursery) +
  #geom_point(data = means, aes(y = ed50_202109), pch = 1, size = 3, color = "red", alpha = 0.5) + 
  geom_point(aes(y = ed50_202109), pch = 1) +
  geom_point(aes(y = ed50_202006), pch = 2) +
  geom_abline(slope = 1, intercept = 0, lty = 2) +
  #geom_label(aes(y = ed50_202109, label = geno)) +
  #stat_cor() +
  coord_fixed(xlim = range(toplongdf$ed50), ylim = range(toplongdf$ed50)) +
  theme_custom(); unadj.corr




# Get all pairwise differences between measurements of the same geno at the same nursery
res.unadj <- toplongdf %>% 
  group_by(nursery, geno) %>% 
  summarise(diff = combn(ed50,2,diff),
            test = combn(date,2,paste, simplify = FALSE)) %>%  
  mutate(pair = unlist(lapply(test, function(x)paste(x,collapse="-")))) %>%  
  select(-test) %>%
  ungroup()


# Get ECDF for plotting
dens <- density(abs(res.unadj$diff), adjust = 0.01)
dens <- tibble(x = dens$x, y = dens$y) %>%
  mutate(cd = cumsum(y)/sum(y))
# Get degree diffs for x% of cases from cumulative density
conf0.5 <- dens$x[which.min(abs(0.5 - dens$cd))]
conf0.9 <- dens$x[which.min(abs(0.9 - dens$cd))]

myecdf <- ggplot(res.unadj, aes(x = abs(diff))) +
  geom_segment(aes(y = 0.5, yend = 0.5, x = 0, xend = conf0.5), lty = 2, alpha = 0.4, lwd = 0.25) +
  geom_segment(aes(x = conf0.5, xend = conf0.5, y = 0, yend = 0.5), lty= 2, alpha = 0.4, lwd = 0.25) +
  geom_segment(aes(y = 0.9, yend = 0.9, x = 0, xend = conf0.9), lty = 2, alpha = 0.4, lwd = 0.25) +
  geom_segment(aes(x = conf0.9, xend = conf0.9, y = 0, yend = 0.9), lty= 2, alpha = 0.4, lwd = 0.25) +
  #geom_rect(data = myvals, aes(xmin = 0, xmax = diff, ymin = 0, ymax = perc), alpha = 0.2) +
  stat_ecdf(color = "red", alpha = 0.5) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 2, 0.25)) +
  coord_cartesian(xlim = c(0, 1.2)) +
  scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 0.9, 1), labels = scales::percent, expand = c(0, 0)) +
  labs(x = "|Test 1 - Test 2| ΔED50 (°C)", y = "Percent of cases") +
  theme_custom(); myecdf
```


# Remove nursery / year effects
```{r}
# Model nursery and year effects to remove from data
indf <- toplongdf
mod <- lm(ed50 ~ nursery:date, data = indf)
# Add residuals from nursery*year fitted values to the grand mean ED50
out <- augment(mod, indf) %>%
  mutate(ed50_adj = mean(indf$ed50) + .resid) %>%
  select(geno, nursery, date, ed50, ed50_adj)
res.adj <- out %>% 
  group_by(nursery, geno) %>% 
  summarise(diff = combn(ed50_adj,2,diff),
            test = combn(date,2,paste, simplify = FALSE)) %>%  
  mutate(pair = unlist(lapply(test, function(x)paste(x,collapse="-")))) %>%  
  select(-test) %>%
  ungroup()

# Get ECDF for plotting
adjdens <- density(abs(res.adj$diff), adjust = 0.1)
adjdens <- tibble(x = adjdens$x, y = adjdens$y) %>%
  mutate(cd = cumsum(y)/sum(y))
# Get degree diffs for x% of cases from cumulative density
adjconf0.5 <- adjdens$x[which.min(abs(0.5 - adjdens$cd))]
adjconf0.9 <- adjdens$x[which.min(abs(0.9 - adjdens$cd))]


# Plot adjusted ED50s 2021 vs. 2020
adj.corr <- out %>% pivot_wider(names_from = date, values_from = c(ed50, ed50_adj)) %>%
  ggplot(aes(x = ed50_adj_202010)) +
  geom_point(aes(y = ed50_adj_202109), pch = 1) + #aes(color = sum.std.error)) +
  geom_point(aes(y = ed50_adj_202006), pch = 2) +
  #geom_smooth(method = "lm") +
  #geom_label(aes(label = geno, y = ed50_adj_202109), size = 2) +
  geom_ribbon(aes(ymin = ..x.. - adjconf0.5, ymax = ..x.. + adjconf0.5), alpha = 0.25) +
  geom_ribbon(aes(ymin = ..x.. - adjconf0.9, ymax = ..x.. + adjconf0.9), alpha = 0.25) +
  #annotate("text", x = 35, y = 37, label = round(adjconf0.9, 3)) +
  #annotate("text", x = 35, y = 36.8, label = round(adjconf0.5, 3)) +
  labs(x = "ED50 (°C) in Test 1", y = "ED50 (°C) in Test 2") +
  geom_abline(aes(slope = 1, intercept = 0), lty = 2, lwd = 0.25) +
  theme_custom() +
  #theme(legend.position = "none") +
  coord_fixed()


ecdf2 <- myecdf +
  #geom_segment(aes(y = 0.5, yend = 0.5, x = 0, xend = adjconf0.5), lty = 2) +
  geom_segment(aes(x = adjconf0.5, xend = adjconf0.5, y = 0, yend = 0.5), lty= 2, lwd = 0.25) +
  geom_text(x = adjconf0.5, y = 0.02, label = round(adjconf0.5, 2), adj = 1) +
  #geom_segment(aes(y = 0.9, yend = 0.9, x = 0, xend = adjconf0.9), lty = 2) +
  geom_segment(aes(x = adjconf0.9, xend = adjconf0.9, y = 0, yend = 0.9), lty= 2, lwd = 0.25) +
  geom_text(x = adjconf0.9, y = 0.02, label = round(adjconf0.9, 2), adj = 1) +
  #geom_rect(data = myvals, aes(xmin = 0, xmax = diff, ymin = 0, ymax = perc), alpha = 0.2) +
  stat_ecdf(data = res.adj, color = "red"); ecdf2
```

```{r}
# Plot combined figure
repro.fig <- plot_grid(unadj.corr, adj.corr, ecdf2, nrow = 1, 
                       labels = "auto", rel_widths = c(0.42, 0.29, 0.29))
ggsave(repro.fig, filename = "output/reprofig.png", width = 183, height = 80, units = "mm")
```





####------
# everything below is older code from arond reef futures conference...
# Filter out ED50 measurements with high error (lower confidence in value)


# Estimate repeatability of ED50 for same genotype
```{r}
# Repeatability
library(rptR)
Rout <- rpt(ed50 ~ nursery * date  + (1|geno), data = toplongdf, 
           grname = c("geno", "Overdispersion", "Fixed", "Residual"), 
           nboot = 1000, parallel = TRUE, adjusted = TRUE)
Rout
plot(Rout)
summary(Rout)
```


# Repeatability of pairwise ranks

# How confident can we be in identifying GROUPS of more/less tolerant corals?
```{r}
####
# GET 2 RANDOM GROUPS OF N CORALS. calc mean diff btw groups in 202010, 202109 (and 202006).
# Look at value of mean difference in 202109 (and 202006) vs. 202010, and get pred. interval.

# Get subset of genos spanning equal bins across range of cot2020ed50_adj distribution
oct2010 <- out %>% filter(date == "202010") 
bins <- oct2010 %>%
  mutate(bin = cut(ed50_adj, breaks = seq(min(ed50_adj), max(ed50_adj), length.out = 10), 
                   include.lowest = TRUE))
bins %>% count(bin)
set.seed(4)
subset <- bins %>% 
  group_by(bin) %>%
  slice_sample(n = 8)  # 4 genos per bin = 36 genos for simulations, including all top and bottom genos

# # Get top vs bot genos?
# outwide <- out %>%
#   pivot_wider(names_from = "date", values_from = c(ed50, ed50_adj)) 
# top25 <- outwide %>%
#   arrange(ed50_adj_202010) %>%
#   tail(20) %>% drop_na(ed50_202109)
# bottom25 <- outwide %>%
#   arrange(ed50_adj_202010) %>%
#   head(20) %>% drop_na(ed50_202109)
# 
# topbot.unadj <- bind_rows(top25, bottom25) %>%
#   select(geno, `202010` = ed50_202010, `202006` = ed50_202006, `202109` = ed50_202109) %>%
#   pivot_longer(c(`202006`, `202109`)) %>% drop_na()
# topbot.adj <- bind_rows(top25, bottom25) %>%
#   select(geno, `202010` = ed50_adj_202010, `202006` = ed50_adj_202006, `202109` = ed50_adj_202109) %>%
#   pivot_longer(c(`202006`, `202109`)) %>% drop_na()

# Format input dataframes
indf.unadj <- out %>%
  filter(geno %in% subset$geno) %>%   # use subset only?
  pivot_wider(names_from = "date", values_from = c(ed50, ed50_adj)) %>%
  select(geno, `202010` = ed50_202010, `202006` = ed50_202006, `202109` = ed50_202109) %>% 
  pivot_longer(c(`202006`, `202109`)) %>% drop_na()
indf.adj <- out %>%
  filter(geno %in% subset$geno) %>%   # use subset only?
  pivot_wider(names_from = "date", values_from = c(ed50, ed50_adj)) %>%
  select(geno, `202010` = ed50_adj_202010, `202006` = ed50_adj_202006, `202109` = ed50_adj_202109) %>%
  pivot_longer(c(`202006`, `202109`)) %>% drop_na()

# Function to compare 2 random groups of specified size
ran <- function(df, groupsize) {
  g <- df %>% group_by(geno) %>% slice_sample(n=1) %>% ungroup() %>%
    slice_sample(n = 2 * groupsize)
  g <- g %>% mutate(group = c(rep(1, groupsize), rep(2, groupsize)))
  r <- suppressMessages(g %>% group_by(group) %>% 
    summarize(mean.1 = mean(`202010`), mean.2 = mean(value)) %>%
    summarize_all(diff) %>%
    mutate(absdiff.1 = abs(mean.1), meandiff.2 = mean.2 * sign(mean.1)))
  return(r)
}


# Run function many times to compare different random groups
# Function to run simulation many tips
reprun <- function(df, nsim, groupsize) replicate(nsim, ran(df, groupsize), simplify = FALSE)

library(furrr)
plan(multiprocess)

# Run simulations on unadjusted ED50 data
runres.unadj <- tibble(groupsize = c(1,3,10)) %>%
  mutate(runout = future_map(groupsize, ~reprun(indf.unadj, 10000, groupsize = .x)),
         runout = map(runout, ~map_dfr(.x, bind_rows)),
         fit = map(runout, ~lm(meandiff.2 ~ absdiff.1, data = .x)),
         pred = map(fit, ~data.frame(fit = predict(.x, newdata = data.frame(absdiff.1 = seq(0, 2, 0.01)),
                                                   interval = "prediction", level = 0.9))),
         pred = map(pred, ~ .x %>% mutate(absdiff.1 = seq(0, 2, 0.01))))
# Fit model for re-test showing same rank as a function of initial test difference
runres.unadj <- runres.unadj %>%
  mutate(mod = map(runout, ~glm(meandiff.2 > 0 ~ absdiff.1, data = .x, family = "binomial")),
         prob = map(mod, ~ data.frame(fit = predict(.x, newdata = data.frame(absdiff.1 = seq(0, 2, 0.01)),
                                                    type = "response"))),
         prob = map(prob, ~ .x %>% mutate(data.frame(absdiff.1 = seq(0, 2, 0.01)))))
         

# Figure showing probability of same rank order in re-test
allprob.unadj <- runres.unadj %>%
  select(groupsize, prob) %>%
  unnest(prob)

ggplot(allprob.unadj, aes(x = absdiff.1, y = fit)) +
  geom_line(aes(lty = factor(groupsize))) +
  scale_x_continuous(breaks = seq(0, 2, 0.25)) +
  scale_y_continuous(limits = c(0.5, 1)) +
  theme_custom() +
  theme(legend.position = c(0.8, 0.2)) +
  labs(x = "∆ED50 in initial test (°C)", y = "Probability of same rank order in re-test")
 

# Supplementary figure showing re-test differences
allout.unadj <- runres.unadj %>% 
  select(groupsize, runout) %>%
  unnest(runout)

allpred.unadj <- runres.unadj %>% 
  select(groupsize, pred) %>%
  unnest(pred)

ggplot(allout.unadj, aes(x = absdiff.1, y = meandiff.2)) +
  facet_wrap(~groupsize) +
  geom_point(alpha = 0.5, color = "gray") +
  geom_ribbon(aes(y = fit.fit, ymin = fit.lwr, ymax = fit.upr), data = allpred.unadj, 
              alpha = 0.2, fill = "blue") +
  geom_hline(aes(yintercept = 0), lty = 1, lwd = 0.25) +
  coord_cartesian(ylim = c(-1.5, 1.5), xlim = c(0, 1.5)) +
  theme_custom()



# Run simulations on ADJusted ED50 data
runres.adj <- tibble(groupsize = c(1,3,10)) %>%
  mutate(runout = future_map(groupsize, ~reprun(indf.adj, 10000, groupsize = .x)),
         runout = map(runout, ~map_dfr(.x, bind_rows)),
         fit = map(runout, ~lm(meandiff.2 ~ absdiff.1, data = .x)),
         pred = map(fit, ~data.frame(fit = predict(.x, newdata = data.frame(absdiff.1 = seq(0, 2, 0.01)),
                                                   interval = "prediction", level = 0.9))),
         pred = map(pred, ~ .x %>% mutate(absdiff.1 = seq(0, 2, 0.01))))
# Fit model for re-test showing same rank as a function of initial test difference
runres.adj <- runres.adj %>%
  mutate(mod = map(runout, ~glm(meandiff.2 > 0 ~ absdiff.1, data = .x, family = "binomial")),
         prob = map(mod, ~ data.frame(fit = predict(.x, newdata = data.frame(absdiff.1 = seq(0, 2, 0.01)),
                                                    type = "response"))),
         prob = map(prob, ~ .x %>% mutate(data.frame(absdiff.1 = seq(0, 2, 0.01)))))

# Figure showing probability of same rank order in re-test
allprob.adj <- runres.adj %>%
  select(groupsize, prob) %>%
  unnest(prob)

ggplot(allprob.adj, aes(x = absdiff.1, y = fit)) +
  geom_line(aes(lty = factor(groupsize))) +
  scale_x_continuous(breaks = seq(0, 2, 0.25)) +
  scale_y_continuous(limits = c(0.5, 1)) +
  theme_custom() +
  theme(legend.position = c(0.8, 0.2)) +
  labs(x = "∆ED50 in initial test (°C)", y = "Probability of same rank order in re-test")
 

# Supplementary figure showing re-test differences
allout.adj <- runres.adj %>% 
  select(groupsize, runout) %>%
  unnest(runout)

allpred.adj <- runres.adj %>% 
  select(groupsize, pred) %>%
  unnest(pred)

ggplot(allout.adj, aes(x = absdiff.1, y = meandiff.2)) +
  facet_wrap(~groupsize) +
  geom_point(alpha = 0.5, color = "gray") +
  geom_ribbon(aes(y = fit.fit, ymin = fit.lwr, ymax = fit.upr), data = allpred.adj, 
              alpha = 0.2, fill = "blue") +
  geom_hline(aes(yintercept = 0), lty = 1, lwd = 0.25) +
  coord_cartesian(ylim = c(-1.5, 1.5), xlim = c(0, 1.5)) +
  theme_custom()



# Combine adj and unadj
# Figure showing probability of same rank order in re-test
allprob <- bind_rows(adj = allprob.adj, unadj = allprob.unadj, .id = "set")

probplot <- ggplot(allprob, aes(x = absdiff.1, y = fit)) +
  geom_line(aes(lty = factor(groupsize), color = set)) +
  #geom_hline(yintercept = 0.95) +
  scale_x_continuous(breaks = seq(0, 2, 0.25)) +
  scale_y_continuous(limits = c(0.5, 1)) +
  scale_linetype(name = "Group size") +
  scale_color_manual(values = c("black", "gray"), guide = "none") +
  theme_custom() +
  theme(legend.position = c(0.8, 0.2)) +
  labs(x = "∆ED50 in initial test (°C)", y = "Probability of same rank order in re-test")

ggsave(probplot, filename = "output/probplot.png", width = 80, height = 80, units = "mm")
```




